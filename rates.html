<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#121218">
  <title>Quiz Aviation - Rat√©s du jour</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css" />
  <script src="config.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: (window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.apiKey) || 'AIzaSyD8hy_cTHQZybJ5RFAzgh7DLIh15Jhwkyw',
      authDomain: "quizaviation-b79ff.firebaseapp.com",
      projectId: "quizaviation-b79ff",
      storageBucket: "quizaviation-b79ff.firebasestorage.app",
      messagingSenderId: "200438765697",
      appId: "1:200438765697:web:3467cf30e905ed586e5580",
      measurementId: "G-N3G7EVGZ84"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    window.auth = firebase.auth();
    window.db = firebase.firestore();
    window._persistenceReady = db.enablePersistence({ synchronizeTabs: true }).catch(err => {
      if (err.code !== 'failed-precondition' && err.code !== 'unimplemented') console.error(err);
    });
  </script>
</head>
<body>
  <!-- Theme toggle -->
  <script>
    (function() {
      var saved = localStorage.getItem('theme');
      if (saved === 'light') document.body.classList.add('light');
    })();
  </script>
  <button id="themeToggle" onclick="(function(){document.body.classList.toggle('light');localStorage.setItem('theme',document.body.classList.contains('light')?'light':'dark');document.getElementById('themeToggle').textContent=document.body.classList.contains('light')?'üåô':'‚òÄÔ∏è'})()">‚òÄÔ∏è</button>
  <button id="ttsToggle" onclick="(function(){var on=localStorage.getItem('ttsEnabled')==='1';localStorage.setItem('ttsEnabled',on?'0':'1');document.getElementById('ttsToggle').textContent=on?'üîá':'üîä';document.getElementById('ttsToggle').title=on?'TTS d√©sactiv√©':'TTS activ√©'})()" title="TTS d√©sactiv√©">üîá</button>
  <script>
    if(document.body.classList.contains('light'))document.getElementById('themeToggle').textContent='üåô';
    if(localStorage.getItem('ttsEnabled')==='1'){document.getElementById('ttsToggle').textContent='üîä';document.getElementById('ttsToggle').title='TTS activ√©';}
  </script>

  <h1>‚ùå Rat√©s du jour</h1>

  <div class="container" id="ratesContainer">
    <p id="ratesLoading" style="text-align:center;color:var(--text-secondary);">Chargement‚Ä¶</p>
  </div>

  <div class="container" style="text-align: center; margin-top: 1rem;">
    <button onclick="window.location='index.html'">Retour Accueil</button>
    <button onclick="window.location='stats.html'">Statistiques</button>
  </div>

  <script>
  (function() {
    // === Helpers TTS ===
    function speakText(text) {
      if (!('speechSynthesis' in window)) return;
      speechSynthesis.cancel();
      var utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'fr-FR';
      utterance.rate = 0.95;
      utterance.pitch = 1.0;
      var voices = speechSynthesis.getVoices();
      var preferredName = localStorage.getItem('ttsPreferredVoiceName') || '';
      var voice = null;
      if (preferredName) voice = voices.find(function(v) { return v.name === preferredName; });
      if (!voice) voice = voices.find(function(v) { return v.lang && v.lang.match(/^fr/i); });
      if (voice) utterance.voice = voice;
      speechSynthesis.speak(utterance);
    }

    // Pr√©-charger les voix
    if ('speechSynthesis' in window) {
      speechSynthesis.getVoices();
      if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = function() { speechSynthesis.getVoices(); };
      }
    }

    // === Data ===
    function getTodayKey() {
      var now = new Date();
      return now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
    }

    // R√©cup√®re le lastViewed depuis localStorage (rapide) ou Firestore (cross-device)
    function getLastViewedTimestamp() {
      try {
        var data = JSON.parse(localStorage.getItem('ratesLastViewed') || '{}');
        if (data.date === getTodayKey()) return data.ts || 0;
      } catch (e) {}
      return 0;
    }

    // Sauvegarde lastViewed en localStorage + Firestore (cross-device)
    function markAsViewed(uid) {
      var payload = { date: getTodayKey(), ts: Date.now() };
      localStorage.setItem('ratesLastViewed', JSON.stringify(payload));
      // Sync to Firestore for cross-device
      if (uid) {
        try {
          db.collection('quizProgress').doc(uid).collection('wrongToday').doc('_meta').set(
            { lastViewed: payload }, { merge: true }
          ).catch(function() {});
        } catch (e) {}
      }
    }

    // Fusionne localStorage + Firestore items, d√©duplique par key+ts
    function mergeItems(localItems, firestoreItems) {
      var map = {};
      function addItem(item) {
        var id = item.key + '_' + item.ts;
        if (!map[id]) map[id] = item;
      }
      (localItems || []).forEach(addItem);
      (firestoreItems || []).forEach(addItem);
      var result = [];
      for (var id in map) result.push(map[id]);
      // Trier par timestamp chronologique
      result.sort(function(a, b) { return a.ts - b.ts; });
      return result;
    }

    // === Render ===
    function render(items, allItemsCount, uid, lastViewed) {
      var container = document.getElementById('ratesContainer');

      // Filtrer : uniquement les items non encore vus
      var unseen = items.filter(function(item) { return item.ts > lastViewed; });

      if (unseen.length === 0) {
        container.innerHTML = '<div class="rates-empty">' +
          '<div class="rates-empty-icon">‚úÖ</div>' +
          '<p>Aucune nouvelle question rat√©e √† r√©viser !</p>' +
          (allItemsCount > 0
            ? '<p style="font-size:0.85rem;color:var(--text-secondary);">Vous avez d√©j√† consult√© les ' + allItemsCount + ' erreur(s) d\'aujourd\'hui.</p>'
            : '<p style="font-size:0.85rem;color:var(--text-secondary);">Lancez un quiz pour commencer !</p>') +
          '</div>';
        markAsViewed(uid);
        return;
      }

      var html = '<div class="rates-header">' +
        '<span class="rates-count">' + unseen.length + ' question' + (unseen.length > 1 ? 's' : '') + ' rat√©e' + (unseen.length > 1 ? 's' : '') + ' √† r√©viser</span>' +
        '<span class="rates-hint">üí° Cliquez sur les r√©ponses pour √©couter la question et la bonne r√©ponse</span>' +
        '</div>';

      unseen.forEach(function(item, idx) {
        var q = item.q;
        var timeStr = new Date(item.ts).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

        html += '<div class="question-block rates-question-block" data-rates-idx="' + idx + '">';
        html += '<div class="rates-meta">';
        html += '<span class="rates-time">üïê ' + timeStr + '</span>';
        html += '<span class="rates-cat">' + (q.categorie || '') + '</span>';
        html += '</div>';
        html += '<div class="question-title">' + (idx + 1) + '. ' + q.question + '</div>';

        if (q.image) {
          html += '<div class="question-image"><img src="' + q.image + '" alt="illustration" onerror="this.style.display=\'none\';" /></div>';
        }

        html += '<div class="answer-list rates-answer-list" data-question="' + encodeURIComponent(q.question) + '" data-correct="' + encodeURIComponent(q.choix[q.bonne_reponse]) + '">';
        q.choix.forEach(function(choixText, i) {
          var cls = '';
          if (i === q.bonne_reponse) cls = 'correct';
          else if (i === item.selected) cls = 'wrong';
          html += '<div style="margin-bottom:4px;"><span class="' + cls + '">' + choixText + '</span></div>';
        });
        html += '</div>';

        // Explication
        if (q.explication) {
          html += '<div class="explication-block"><strong>Explication :</strong> ' + q.explication + '</div>';
        }
        if (q.explication_images && q.explication_images.length) {
          q.explication_images.forEach(function(img) {
            html += '<div class="explication-image"><img src="' + img + '" alt="explication" onerror="this.style.display=\'none\';" /></div>';
          });
        }

        html += '</div>';
      });

      container.innerHTML = html;

      // Attach TTS click listeners on answer zones
      var answerLists = container.querySelectorAll('.rates-answer-list');
      answerLists.forEach(function(el) {
        el.style.cursor = 'pointer';
        el.addEventListener('click', function() {
          var questionText = decodeURIComponent(el.getAttribute('data-question'));
          var correctText = decodeURIComponent(el.getAttribute('data-correct'));
          speakText(questionText + '‚Ä¶ La bonne r√©ponse est : ' + correctText);
        });
      });

      // Marquer comme vu APR√àS l'affichage
      markAsViewed(uid);
    }

    // === Init : charge depuis Firestore (cross-device) + localStorage (local) ===
    function initRates() {
      var uid = (auth.currentUser && auth.currentUser.uid) || localStorage.getItem('cachedUid');
      var todayKey = getTodayKey();

      // Charger les items localStorage imm√©diatement
      var localItems = [];
      try {
        var localData = JSON.parse(localStorage.getItem('wrongToday') || '{}');
        if (localData.date === todayKey) localItems = localData.items || [];
      } catch (e) {}

      // Charger le lastViewed local
      var lastViewed = getLastViewedTimestamp();

      if (!uid) {
        // Pas connect√© ‚Üí afficher uniquement localStorage
        render(localItems, localItems.length, null, lastViewed);
        return;
      }

      // Charger depuis Firestore (inclut le cache local Firestore si offline)
      var docRef = db.collection('quizProgress').doc(uid).collection('wrongToday').doc(todayKey);
      var metaRef = db.collection('quizProgress').doc(uid).collection('wrongToday').doc('_meta');

      // Lancer les 2 lectures en parall√®le
      Promise.all([
        docRef.get().catch(function() { return null; }),
        metaRef.get().catch(function() { return null; })
      ]).then(function(results) {
        var fsDoc = results[0];
        var metaDoc = results[1];

        var fsItems = [];
        if (fsDoc && fsDoc.exists) {
          var fsData = fsDoc.data();
          fsItems = fsData.items || [];
        }

        // lastViewed cross-device : prendre le max entre localStorage et Firestore
        var fsLastViewed = 0;
        if (metaDoc && metaDoc.exists) {
          var meta = metaDoc.data();
          if (meta.lastViewed && meta.lastViewed.date === todayKey) {
            fsLastViewed = meta.lastViewed.ts || 0;
          }
        }
        var effectiveLastViewed = Math.max(lastViewed, fsLastViewed);
        // Synchroniser le lastViewed local si Firestore est plus r√©cent
        if (fsLastViewed > lastViewed) {
          localStorage.setItem('ratesLastViewed', JSON.stringify({ date: todayKey, ts: fsLastViewed }));
        }

        // Fusionner localStorage + Firestore items
        var allItems = mergeItems(localItems, fsItems);

        render(allItems, allItems.length, uid, effectiveLastViewed);
      }).catch(function(err) {
        console.warn('[rates] Firestore read error, fallback localStorage:', err);
        render(localItems, localItems.length, uid, lastViewed);
      });
    }

    // Auth check then init
    var initDone = false;
    function doInit() {
      if (initDone) return;
      initDone = true;
      initRates();
    }

    auth.onAuthStateChanged(function(user) {
      if (user || localStorage.getItem('cachedUid')) { doInit(); }
      else { window.location = 'index.html'; }
    });
    setTimeout(function() {
      if (!initDone && localStorage.getItem('cachedUid')) doInit();
    }, 2000);
  })();
  </script>
</body>
</html>
