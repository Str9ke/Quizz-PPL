<!DOCTYPE html>
<html lang="fr">
<head>
    <script>
      // REDIRECTION AUTOMATIQUE EN MODE AUTOSTART (ex√©cut√© tr√®s t√¥t, avant Firebase)
      (function() {
        const autoStartQuiz = localStorage.getItem('autoStartQuiz') === 'true';
        const cat = localStorage.getItem('quizCategory');
        const mode = localStorage.getItem('quizMode');
        const nb = localStorage.getItem('quizNbQuestions');
        
        // Si autoStartQuiz est activ√©, redirection vers le quiz
        if (autoStartQuiz && !window.location.search.includes('accueil')) {
          if (cat && mode && nb) {
            // IMPORTANT: Nettoyer currentQuestions pour FORCER la r√©g√©n√©ration de nouvelles questions
            localStorage.removeItem('currentQuestions');
            // Redirection IMMEDIATE sans setTimeout
            window.location = 'quiz.html';
          }
        }
      })();
    </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#121218">
  <title>Quiz Aviation - Accueil</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="style.css" />
  <!-- Charger la configuration Firebase (cl√© API) AVANT les SDK -->
  <script src="config.js"></script>
  <!-- Inclusion des SDK Firebase en mode compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script>
    // Configuration Firebase obtenue depuis la console Firebase
    // NOTE: apiKey is read from window.FIREBASE_CONFIG if provided (see config.example.js)
    const firebaseConfig = {
      apiKey: (window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.apiKey) || 'AIzaSyD8hy_cTHQZybJ5RFAzgh7DLIh15Jhwkyw',
      authDomain: "quizaviation-b79ff.firebaseapp.com",
      projectId: "quizaviation-b79ff",
      storageBucket: "quizaviation-b79ff.firebasestorage.app",
      messagingSenderId: "200438765697",
      appId: "1:200438765697:web:3467cf30e905ed586e5580",
      measurementId: "G-N3G7EVGZ84"
    };

    // Initialiser Firebase
    firebase.initializeApp(firebaseConfig);
    // Attacher Auth et Firestore √† window pour les rendre globalement accessibles
    window.auth = firebase.auth();
    window.db = firebase.firestore();
    // Activer la persistance hors-ligne Firestore (stocker la promesse pour l'attendre)
    window._persistenceReady = db.enablePersistence({ synchronizeTabs: true }).catch(err => {
      if (err.code === 'failed-precondition') {
        console.warn('[Firestore] Persistance impossible : plusieurs onglets ouverts');
      } else if (err.code === 'unimplemented') {
        console.warn('[Firestore] Persistance non support√©e par ce navigateur');
      }
    });

    // Surveille l'√©tat de connexion de l'utilisateur
    let indexInitTriggered = false;
    auth.onAuthStateChanged(user => {
      if (user) {
        // Sauvegarder le UID dans localStorage pour le mode offline
        localStorage.setItem('cachedUid', user.uid);
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("quizContainer").style.display = "block";
        if (!indexInitTriggered && typeof initIndex === 'function') {
          indexInitTriggered = true;
          initIndex();
        }
      } else if (localStorage.getItem('cachedUid')) {
        // Auth null mais UID en cache ‚Üí d√©marrer en mode offline (navigator.onLine peut mentir)
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("quizContainer").style.display = "block";
        if (!indexInitTriggered && typeof initIndex === 'function') {
          indexInitTriggered = true;
          initIndex();
        }
      } else {
        document.getElementById("loginContainer").style.display = "block";
        document.getElementById("quizContainer").style.display = "none";
      }
    });
    // S√©curit√© : si auth ne fire pas dans les 2s et qu'on a un cachedUid, d√©marrer quand m√™me
    setTimeout(() => {
      if (!indexInitTriggered && localStorage.getItem('cachedUid')) {
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("quizContainer").style.display = "block";
        indexInitTriggered = true;
        if (typeof initIndex === 'function') initIndex();
      }
    }, 2000);
  </script>
</head>
<body>
  <!-- Theme toggle -->
  <script>
    // Appliquer le th√®me sauvegard√© (dark par d√©faut)
    (function() {
      const saved = localStorage.getItem('theme');
      if (saved === 'light') document.body.classList.add('light');
    })();
  </script>
  <button id="themeToggle" onclick="(function(){document.body.classList.toggle('light');localStorage.setItem('theme',document.body.classList.contains('light')?'light':'dark');document.getElementById('themeToggle').textContent=document.body.classList.contains('light')?'üåô':'‚òÄÔ∏è'})()">‚òÄÔ∏è</button>
  <button id="ttsToggle" onclick="(function(){var on=localStorage.getItem('ttsEnabled')==='1';localStorage.setItem('ttsEnabled',on?'0':'1');document.getElementById('ttsToggle').textContent=on?'üîá':'üîä';document.getElementById('ttsToggle').title=on?'TTS d√©sactiv√©':'TTS activ√©'})()" title="TTS d√©sactiv√©">üîá</button>
  <script>
    if(document.body.classList.contains('light'))document.getElementById('themeToggle').textContent='üåô';
    if(localStorage.getItem('ttsEnabled')==='1'){document.getElementById('ttsToggle').textContent='üîä';document.getElementById('ttsToggle').title='TTS activ√©';}
  </script>
  <h1>Quiz Aviation - Accueil</h1>
  <div id="lastUpdateInfo" style="text-align:center;font-size:12px;color:var(--text-secondary);margin-top:-6px;margin-bottom:8px;"></div>
  <script>
    // Afficher la date/heure de derni√®re mise √† jour du site
    (function() {
      // Date de derni√®re mise √† jour (mise √† jour manuellement √† chaque d√©ploiement)
      var LAST_UPDATE = '2026-02-22T11:16:41';
      var d = new Date(LAST_UPDATE);
      var pad = function(n) { return n < 10 ? '0' + n : n; };
      var formatted = pad(d.getDate()) + '/' + pad(d.getMonth()+1) + '/' + d.getFullYear()
        + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
      document.addEventListener('DOMContentLoaded', function() {
        var el = document.getElementById('lastUpdateInfo');
        if (el) el.textContent = 'Derni\u00e8re mise \u00e0 jour : ' + formatted;
      });
    })();
  </script>
  <script>
    // EARLY: si on a un cachedUid, afficher imm√©diatement l'interface quiz
    // et masquer le login (√©vite le flash du formulaire en mode offline)
    (function() {
      if (localStorage.getItem('cachedUid')) {
        // quizContainer sera affich√© d√®s qu'il existera dans le DOM
        document.addEventListener('DOMContentLoaded', function() {
          var lc = document.getElementById('loginContainer');
          var qc = document.getElementById('quizContainer');
          if (lc) lc.style.display = 'none';
          if (qc) qc.style.display = 'block';
        });
      } else {
        // Pas de cachedUid ‚Üí montrer le login
        document.addEventListener('DOMContentLoaded', function() {
          var lc = document.getElementById('loginContainer');
          if (lc) lc.style.display = 'block';
        });
      }
    })();
  </script>

  <!-- Compteur de questions r√©pondues aujourd'hui (recr√©√© par ensureDailyStatsBarVisible) -->
  <div id="dailyStatsBar" style="display:none;"></div>

  <!-- Formulaire de connexion/inscription -->
  <div id="loginContainer" class="container" style="display:none;">
    <h2>Connexion / Inscription</h2>
    <form id="loginForm">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="Mot de passe (min. 6 caract√®res)" required>
      <button type="submit">Se connecter / S'inscrire</button>
    </form>
  </div>

  <!-- Interface du quiz, affich√©e apr√®s authentification -->
  <div id="quizContainer" class="container" style="display: none;">
    <!-- S√©lection de la cat√©gorie -->
    <label for="categorie">Cat√©gorie :</label>
    <select id="categorie" onchange="categoryChanged()">
      <!-- Options g√©n√©r√©es dynamiquement par updateCategorySelect() -->
    </select>
    <br><br>
    <!-- Choix du nombre de questions -->
    <label for="nbQuestions">Nombre de questions :</label>
    <input type="number" id="nbQuestions" value="5" min="1">
    <br><br>
    <!-- Choix du mode -->
    <label for="mode">Mode :</label>
    <select id="mode">
      <!-- Options mises √† jour par updateModeCounts() -->
    </select>
    <br><br>
    
    <!-- Option D√©marrage automatique -->
    <label for="autoStartCheckbox" style="margin-top: 1rem; display: block;">
      <input type="checkbox" id="autoStartCheckbox" onchange="toggleAutoStart()">
      <strong>D√©marrage automatique</strong> (au prochain lancement, le quiz se lancera automatiquement avec cette configuration)
    </label>
    <label for="correctionImmediateCheckbox" style="margin-top: 0.5rem; display: block;">
      <input type="checkbox" id="correctionImmediateCheckbox">
      <strong>Correction imm√©diate</strong> (chaque r√©ponse est corrig√©e instantan√©ment)
    </label>

    <!-- S√©lecteur de voix TTS -->
    <div id="voiceSelectorSection">
      <label for="voiceSelect"><strong>üîä Voix TTS :</strong></label>
      <div class="voice-selector-row">
        <select id="voiceSelect"></select>
        <button type="button" id="btnTestVoice" onclick="testSelectedVoice()">‚ñ∂ Tester</button>
      </div>
      <div id="voiceInfo"></div>
    </div>
    <br><br>
    
    <button id="btnStart" disabled onclick="demarrerQuiz()">D√©marrer le Quiz</button>
    <button onclick="window.location='stats.html'">Voir les Statistiques</button>
    <button class="btn-rates" onclick="window.location='rates.html'">‚ùå Rat√©s du jour <span id="ratesBadge" class="rates-badge" style="display:none;"></span></button>
    <br><br>
    <div id="progressionContainer" style="margin-top: 1rem; background: var(--bg-question); padding: 1rem; border-radius: 4px;"></div>
    <br><br>
    <!-- Bouton de d√©connexion -->
    <button id="btnLogout">D√©connexion</button>
    <br><br>
  </div>

  <!-- Placeholder pour l'√©l√©ment manquant -->
  <div id="missingElement"></div>

  <!-- Inclusion de votre script principal -->
  <script src="js/globals.js?v=20260222x"></script>
  <script src="js/helpers.js?v=20260222x"></script>
  <script src="js/categories.js?v=20260222x"></script>
  <script src="js/stats.js?v=20260222x"></script>
  <script src="js/quiz.js?v=20260222x"></script>
  <script src="js/init.js?v=20260222x"></script>
  <script src="js/offline.js?v=20260222x"></script>

  <!-- S√©lecteur de voix TTS : population & test -->
  <script>
  (function() {
    var select = document.getElementById('voiceSelect');
    var infoDiv = document.getElementById('voiceInfo');
    if (!select) return;

    var femaleNames = ['denise','amelie','am√©lie','aurelie','aur√©lie','caroline','virginie','marie',
      'hortense','eloise','√©lo√Øse','sylvie','c√©line','celine','lea','l√©a','nathalie','julie',
      'sophie','isabelle','alice','lucienne','brigitte','aria','jenny','clara','coralie',
      'josephine','jos√©phine','vivienne','yvette','charline','ren√©e','renee','salli','kendra',
      'joanna','ivy','kimberly','ruth','emma','olivia','anna'];
    var maleNames = ['paul','thomas','henri','nicolas','pierre','mathieu','guillaume','patrick',
      'raphael','rapha√´l','alain','jean','luc','jacques','fran√ßois','francois','claude',
      'vivien','fabrice','yves','joey','matthew','justin','kevin','stephen','brian','gregory'];

    function genderIcon(name) {
      var n = name.toLowerCase();
      for (var i = 0; i < femaleNames.length; i++) { if (n.indexOf(femaleNames[i]) >= 0) return ' ‚ôÄ'; }
      for (var i = 0; i < maleNames.length; i++) { if (n.indexOf(maleNames[i]) >= 0) return ' ‚ôÇ'; }
      return '';
    }

    function qualityBadge(name) {
      var n = name.toLowerCase();
      if (n.indexOf('natural') >= 0 || n.indexOf('neural') >= 0) return ' ‚ú®HD';
      if (n.indexOf('online') >= 0) return ' ‚òÅÔ∏è';
      return '';
    }

    function populateVoices() {
      if (!('speechSynthesis' in window)) {
        select.innerHTML = '<option>TTS non support√©</option>';
        return;
      }
      var voices = speechSynthesis.getVoices();
      var frVoices = voices.filter(function(v) { return v.lang && v.lang.match(/^fr/i); });
      if (frVoices.length === 0 && voices.length === 0) return;
      if (frVoices.length === 0) frVoices = voices;

      var saved = localStorage.getItem('ttsPreferredVoiceName') || '';
      select.innerHTML = '';

      var defOpt = document.createElement('option');
      defOpt.value = '';
      defOpt.textContent = 'üîÑ Voix par d√©faut du syst√®me';
      select.appendChild(defOpt);

      frVoices.forEach(function(v) {
        var opt = document.createElement('option');
        opt.value = v.name;
        var label = v.name + genderIcon(v.name) + qualityBadge(v.name);
        if (v.localService) label += ' üì±';
        opt.textContent = label;
        if (v.name === saved) opt.selected = true;
        select.appendChild(opt);
      });

      updateVoiceInfo();
    }

    function updateVoiceInfo() {
      if (!('speechSynthesis' in window)) return;
      var voices = speechSynthesis.getVoices();
      var selectedName = select.value;
      if (!selectedName) {
        infoDiv.textContent = 'La premi√®re voix fran√ßaise disponible sera utilis√©e.';
        return;
      }
      var voice = voices.find(function(v) { return v.name === selectedName; });
      if (voice) {
        var info = voice.lang;
        if (voice.localService) info += ' ¬∑ Locale (hors-ligne)';
        else info += ' ¬∑ En ligne';
        if (voice.default) info += ' ¬∑ Par d√©faut';
        infoDiv.textContent = info;
      }
    }

    select.addEventListener('change', function() {
      localStorage.setItem('ttsPreferredVoiceName', select.value);
      updateVoiceInfo();
    });

    populateVoices();
    if ('speechSynthesis' in window && speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = function() { populateVoices(); };
    }

    var sampleAnswers = [
      "L'angle d'incidence est l'angle entre la corde de l'aile et le vent relatif.",
      "La portance est proportionnelle au carr√© de la vitesse.",
      "En cas de panne moteur, la priorit√© est de maintenir la vitesse de finesse max.",
      "Le transpondeur doit √™tre r√©gl√© sur 7700 en cas de d√©tresse.",
      "La pression atmosph√©rique standard au niveau de la mer est 1013 virgule 25 hectopascals.",
      "L'effet de sol augmente la portance et diminue la tra√Æn√©e induite.",
      "La VNE est la vitesse √† ne jamais d√©passer.",
      "Le QNH est le calage altim√©trique qui permet de lire l'altitude.",
      "Le facteur de charge en virage √† 60 degr√©s d'inclinaison est de 2G.",
      "Un NOTAM est un avis aux navigateurs a√©riens diffus√© par les services de l'information a√©ronautique."
    ];

    window.testSelectedVoice = function() {
      if (!('speechSynthesis' in window)) { alert('TTS non support√© sur cet appareil'); return; }
      speechSynthesis.cancel();
      var text = sampleAnswers[Math.floor(Math.random() * sampleAnswers.length)];
      var utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'fr-FR';
      utterance.rate = 0.95;
      utterance.pitch = 1.0;
      var voices = speechSynthesis.getVoices();
      var selectedName = select.value;
      if (selectedName) {
        var voice = voices.find(function(v) { return v.name === selectedName; });
        if (voice) utterance.voice = voice;
      } else {
        var frVoice = voices.find(function(v) { return v.lang && v.lang.match(/^fr/i); });
        if (frVoice) utterance.voice = frVoice;
      }
      var btn = document.getElementById('btnTestVoice');
      btn.textContent = 'üîä Lecture...';
      btn.disabled = true;
      utterance.onend = function() { btn.textContent = '‚ñ∂ Tester'; btn.disabled = false; };
      utterance.onerror = function() { btn.textContent = '‚ñ∂ Tester'; btn.disabled = false; };
      speechSynthesis.speak(utterance);
    };
  })();
  </script>

  <!-- Gestion de la connexion et d√©connexion -->
  <script>
  // Mise √† jour du badge "Rat√©s du jour" (localStorage rapide + Firestore cross-device)
  (function() {
    var now = new Date();
    var todayKey = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

    function updateBadge(unseen) {
      var badge = document.getElementById('ratesBadge');
      if (badge && unseen > 0) { badge.textContent = unseen; badge.style.display = 'inline-block'; }
      else if (badge) { badge.style.display = 'none'; }
    }

    // 1) Instant : localStorage
    try {
      var data = JSON.parse(localStorage.getItem('wrongToday') || '{}');
      var localItems = (data.date === todayKey) ? (data.items || []) : [];
      var viewed = JSON.parse(localStorage.getItem('ratesLastViewed') || '{}');
      var lastTs = (viewed.date === todayKey) ? (viewed.ts || 0) : 0;
      var unseen = localItems.filter(function(item) { return item.ts > lastTs; }).length;
      updateBadge(unseen);
    } catch (e) {}

    // 2) Async : Firestore (pour cross-device, ex: PC voit les rat√©s du t√©l√©phone)
    function checkFirestoreBadge() {
      var uid = (window.auth && auth.currentUser && auth.currentUser.uid) || localStorage.getItem('cachedUid');
      if (!uid || !window.db) return;
      var docRef = db.collection('quizProgress').doc(uid).collection('wrongToday').doc(todayKey);
      var metaRef = db.collection('quizProgress').doc(uid).collection('wrongToday').doc('_meta');
      Promise.all([docRef.get(), metaRef.get()]).then(function(results) {
        var fsDoc = results[0]; var metaDoc = results[1];
        var fsItems = (fsDoc && fsDoc.exists) ? (fsDoc.data().items || []) : [];
        var fsLastViewed = 0;
        if (metaDoc && metaDoc.exists && metaDoc.data().lastViewed && metaDoc.data().lastViewed.date === todayKey) {
          fsLastViewed = metaDoc.data().lastViewed.ts || 0;
        }
        // Merge local + firestore
        var map = {};
        function add(it) { map[it.key + '_' + it.ts] = it; }
        try { var ld = JSON.parse(localStorage.getItem('wrongToday') || '{}'); if (ld.date === todayKey) (ld.items || []).forEach(add); } catch(e){}
        fsItems.forEach(add);
        var allItems = []; for (var k in map) allItems.push(map[k]);
        var vw = 0;
        try { var v = JSON.parse(localStorage.getItem('ratesLastViewed') || '{}'); if (v.date === todayKey) vw = v.ts || 0; } catch(e){}
        var effectiveLV = Math.max(vw, fsLastViewed);
        var count = allItems.filter(function(it) { return it.ts > effectiveLV; }).length;
        updateBadge(count);
      }).catch(function(){});
    }
    // D√©lai pour laisser Firebase s'initialiser
    setTimeout(checkFirestoreBadge, 2500);
  })();
  </script>
  <script>
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;

      if (password.length < 6) {
        alert("Le mot de passe doit contenir au moins 6 caract√®res.");
        return;
      }

      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
      } catch (error) {
        console.error("Erreur lors de la connexion :", error);
        if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-login-credentials') {
          try {
            const newUser = await auth.createUserWithEmailAndPassword(email, password);
          } catch (creationError) {
            console.error("Erreur lors de la cr√©ation du compte :", creationError);
            alert("Erreur lors de la cr√©ation du compte : " + creationError.message);
          }
        } else {
          alert("Erreur de connexion : " + error.message);
        }
      }
    });

    document.getElementById('btnLogout').addEventListener('click', async () => {
      try {
        localStorage.removeItem('cachedUid');
        await auth.signOut();
        window.location.reload();
      } catch (error) {
        console.error("Erreur lors de la d√©connexion :", error);
      }
    });
  </script>
</body>
</html>
